# Analysis of QM part with multiWFN
This workflow describes the anlysis of QM part of a QMMM calculation.
It focuses on the metals in the QM part. The partitioning of the physical space 
can be done either within the Hirshfeld method (TODO: citation) or the Bader QTAIM (TODO: citation).
Within the chosen partitioning the following is analyzed:

- spin population
- atomic charges
- localization and delocalization indices

If the inital wave function contains localized orbitals, also:
- metal-based orbitals 

The following files and programs are required:
- geometry/basis set/wave function file (GBW) from ORCA
- `orca_2mkl` utility from ORCA
- `MultiWFN` at least v3.7

Optional are:
- `orca_loc` utility to localize orbitals (assuming at least ORCA v4.2)
- `qmatoms` and `xplor.psf` file for easy mapping of atom indices


# step 1: convert GBW to molden file
`MultiWFN` can handle molden input files generated by the `orca_2mkl` utility. If some localization
of the orbitals is required, one should do this now with the `orca_loc` utility. 

## optional: localize orbitals in GBW
Run `orca_loc orca_loc_alpha.inp` and then `orca_loc orca_loc_beta.inp`. This will localize first the alhpa and then
the beta orbitals. Make sure to specify correcly:
- the `*.gbw` name in `orca_loc_alpha.inp`
- number of all occupied alpha orbitals in `orca_loc_alpha.inp` and beta orbitals in `orca_loc_beta.inp` (these numbers differ for non-singlets)
- the preferred localization method in _both_ `orca_loc_alpha.inp` and `orca_loc_beta.inp`
- note: `orca_loc` inp format changed in ORCA v4.2

## create molden file from GBW
Run `orca_2mkl $BASENAME -molden` to create `$BASENAME.molden.input`. The default basename after localization is `BASENAME=loc`.

# step 2: analyze molden file with MultiWFN
Decide on either the Hirshfeld method or the Bader method to partitioning the physical space.
1. Hirshfeld is cheaper (56 atoms: 5 min on 4 cores), because it uses predefined densities of the neutral atoms for counting what belongs to an atom. 
This can lead to trouble for atoms in different and/or anisotropic environments. Because the method uses
atomic densities, each point in space belongs with a certain weight to every atom, Hirshfeld is a fuzzy partitioning.
2. Bader defines the volume around an atom based on the surface of minimal electron density between two atoms.
This step takes significantly longer (56 atoms: 12 h on 4 cores). It accounts for different chemical environments, because the volumes can take any possible shape.
Each point in space belongs to exactly one atom, Bader leads to a discrete partitioning.

Run `Multiwfn $BASENAME.molden.input < multi_bader.inp | tee multi_bader.out` or 
`Multiwfn $BASENAME.molden.input < multi_hirsh.inp | tee multi_hirsh.out`
This will generate the following files
- `multi_*.out` contains
	- atomic charges (for Hirshfeld: both Hirshfeld and CM5)
	- atomic alpha and beta spin population
	- specific to `multi_bader.out`
		- assingment of basins to atoms (assumed here that mapping is clear)
- `orbcomp.txt` conatins
	- compositions of alpha and beta orbitals (beta starts after alpha)
	- numbers are either atoms (Hirshfeld) or basins (Bader)
- `LIDI.txt` contains
	- localization and delocalization indices for alpha and beta
	- numbers are either atoms (Hirshfeld) or basins (Bader)
