# Analysis of QM part with multiWFN
This workflow describes the analysis of QM part of a QMMM calculation.
It focuses on the metals in the QM part.
The partitioning of the physical space can be done either within the Hirshfeld method (TODO: citation) 
or the Bader QTAIM (TODO: citation).
Within the chosen partitioning the following is analyzed:

- spin population
- atomic charges
- localization and delocalization indices
- atomic contributions to orbitals (only sensible for localized orbitals)

The following files and programs are required:
- geometry/basis set/wave function file (GBW) from ORCA
- `orca_2mkl` utility from ORCA
- `MultiWFN` at least v3.7

Optional are:
- `orca_loc` utility to localize orbitals (assuming at least ORCA v4.2)
- ORCA output file for automatic determination of orbital ranges for localization
- `qmatoms` and `xplor.psf` file for easy mapping of atom indices

# quick start
- run
	- `write_orca_loc_input.py orca.out`
	- `orca_loc orca_loc_alpha.inp` 
	- `orca_loc orca_loc_beta.inp`
	- `orca_2mkl loc -molden` 
	- either or
		- `Multiwfn $BASENAME.molden.input < multi_bader.inp | tee multi_bader.out`  
		- `Multiwfn $BASENAME.molden.input < multi_hirsh.inp | tee multi_hirsh.out`
	- `parse_multiwfn.py`
	

# step 1: convert GBW to molden file
`MultiWFN` can handle molden input files generated by the `orca_2mkl` utility.
If some localization of the orbitals is required, one should do this first with the `orca_loc` utility. 

## optional: localize orbitals in GBW
- modify `orca_loc_alpha.inp` and `orca_loc_beta.inp` (note: `orca_loc` inp format changed in ORCA v4.2)
	- ranges for alpha and beta orbitals (these numbers differ for non-singlets)
	- name of initial `*.gbw` (only `orca_loc_alpha.inp`)
	- preferred localization method 
	- optional: generate `orca_loc_alpha.inp` and `orca_loc_beta.inp` with `write_orca_loc_input.py orca.out` (requires ORCA output)
- run `orca_loc orca_loc_alpha.inp` 
- run `orca_loc orca_loc_beta.inp`

## create molden file from GBW
- run `orca_2mkl $BASENAME -molden` (creates `$BASENAME.molden.input`, default: `BASENAME=loc`)

# step 2: analyze molden file with MultiWFN
Decide on either the Hirshfeld method or the Bader method to partitioning the physical space.
1. Hirshfeld is cheaper (56 atoms: 5 min on 4 cores), because it uses predefined densities of the neutral atoms for counting what belongs to an atom. 
This can lead to trouble for atoms in different and/or anisotropic environments. Because the method uses
atomic densities, each point in space belongs with a certain weight to every atom, Hirshfeld is a fuzzy partitioning.
2. Bader defines the volume around an atom based on the surface of minimal electron density between two atoms.
This step takes significantly longer (56 atoms: 12 h on 4 cores). It accounts for different chemical environments, because the volumes can take any possible shape.
Each point in space belongs to exactly one atom, Bader leads to a discrete partitioning.

The following files will be generated:
- `multi_*.out` contains
	- atomic charges (for Hirshfeld: both Hirshfeld and CM5)
	- atomic alpha and beta spin population
	- specific to `multi_bader.out`
		- assingment of basins to atoms (assumed here that mapping is clear)
- `orbcomp.txt` contains
	- compositions of alpha and beta orbitals (beta starts after alpha)
	- numbers are either atoms (Hirshfeld) or basins (Bader)
- `LIDI.txt` contains
	- localization and delocalization indices for alpha and beta
	- numbers are either atoms (Hirshfeld) or basins (Bader)

## run MultiWFN
- run either 
	- `Multiwfn $BASENAME.molden.input < multi_bader.inp | tee multi_bader.out` or 
	- `Multiwfn $BASENAME.molden.input < multi_hirsh.inp | tee multi_hirsh.out`

## analyze MultiWFN output
- run `parse_multiwfn.py`
